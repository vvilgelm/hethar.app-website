<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>hethar — presence breach</title>
<meta name="description" content="Hethar — presence that lives with you. Not an assistant. A second you." />

<!-- SEO & Social -->
<link rel="canonical" href="https://hethar.app/" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://hethar.app/" />
<meta property="og:title" content="hethar — presence breach" />
<meta property="og:description" content="Not an assistant. A second presence that lives with you." />
<meta property="og:image" content="https://hethar.app/assets/opengraph/og.jpg" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:url" content="https://hethar.app/" />
<meta name="twitter:title" content="hethar — presence breach" />
<meta name="twitter:description" content="Not an assistant. A second presence that lives with you." />
<meta name="twitter:image" content="https://hethar.app/assets/opengraph/og.jpg" />

<!-- Favicons -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png">

<!-- Security Headers (CSP) -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://plausible.io; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://plausible.io https://ipapi.co; font-src 'self'; frame-src 'none'; object-src 'none';">

<!-- Preload critical font (when you add it) -->
<!-- <link rel="preload" href="/assets/fonts/your-font.woff2" as="font" type="font/woff2" crossorigin> -->

<style>
  /* PRESENCE BREACH — minimal, high-contrast, cinematic */
  :root{
    --bg:#000; --fg:#e8e8e8; --muted:#9aa0a6; --accent:#00ff7f; 
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
    --ease: cubic-bezier(.22,.61,.36,1);
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;overflow-x:hidden;}
  *{box-sizing:border-box}
  
  /* Skip intro button (accessibility) */
  .skip-intro{
    position:fixed;top:20px;right:20px;z-index:200;padding:8px 12px;border-radius:8px;
    background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);
    color:var(--muted);font-size:12px;font-family:var(--mono);cursor:pointer;
    transition:all .18s var(--ease);
  }
  .skip-intro:hover,.skip-intro:focus{background:rgba(255,255,255,0.1);color:var(--fg);outline:2px solid var(--accent);outline-offset:2px;}
  
  .full{height:100vh;width:100vw;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
  .center-col{display:flex;flex-direction:column;gap:14px;align-items:center;max-width:1100px;padding:24px;text-align:center}
  .cursor{display:inline-block;width:10px;height:26px;background:var(--fg);vertical-align:middle;animation:blink 1s steps(2) infinite}
  @keyframes blink{50%{opacity:0}}
  .console{font-family:var(--mono);font-size:20px;letter-spacing:0.02em;line-height:1.6}
  .muted{color:var(--muted);font-size:14px}
  .ghost-green{color:#00ff7f}
  
  /* Matrix trail canvas */
  #matrixCanvas{position:fixed;inset:0;pointer-events:none;mix-blend-mode:screen;opacity:0.07;z-index:1}
  
  /* Memory residue canvas */
  #residueCanvas{position:fixed;inset:0;pointer-events:none;mix-blend-mode:screen;opacity:0.12;z-index:2}
  
  /* Shadow cursor (predictive companion) */
  #shadowCursor{
    position:fixed;pointer-events:none;width:12px;height:12px;border-radius:50%;
    background:rgba(255,255,255,.18);transform:translate(-50%,-50%);
    mix-blend-mode:screen;z-index:9999;transition:opacity .2s;
    box-shadow:0 0 12px rgba(255,255,255,0.3);
  }
  #shadowCursor::after{
    content:'';position:absolute;inset:-4px;border-radius:50%;
    border:1px solid rgba(255,255,255,0.1);animation:pulse 2s ease-in-out infinite;
  }
  @keyframes pulse{0%,100%{transform:scale(1);opacity:0.3} 50%{transform:scale(1.4);opacity:0}}
  
  /* Breach animation overlay */
  .breach{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:30;pointer-events:none;
    background:linear-gradient(180deg, rgba(0,0,0,0.65), rgba(0,0,0,0.85));
    transition:opacity .45s var(--ease);
  }
  .breach.hidden{opacity:0;pointer-events:none}
  
  /* Dossier screens */
  .dossier{height:100vh;width:100vw;display:flex;align-items:center;justify-content:center;position:relative;z-index:40;scroll-snap-align:start}
  .card{max-width:920px;padding:48px 36px;border-radius:6px;text-align:left}
  .line{font-family:var(--mono);font-size:36px;line-height:1.2;font-weight:700;letter-spacing:-0.02em}
  .line.muted{font-size:18px;color:var(--muted);font-weight:400}
  
  /* Dossier container with snap scrolling */
  #dossierContainer{
    scroll-snap-type:y mandatory;
    overflow-y:scroll;
    height:100vh;
    scroll-behavior:smooth;
  }
  
  /* Whispers */
  .whisper{
    position:fixed;left:28px;bottom:28px;padding:10px 14px;border-radius:10px;
    background:rgba(10,10,10,0.85);backdrop-filter:blur(8px);
    color:var(--muted);font-family:var(--mono);font-size:13px;
    opacity:0;transform:translateY(6px);transition:opacity .22s var(--ease),transform .22s var(--ease);
    z-index:60;max-width:420px;
    border:1px solid rgba(255,255,255,0.06);
  }
  .whisper.on{opacity:1;transform:translateY(0)}
  
  /* Temporal rewind UI */
  #rewindUI{
    position:fixed;right:20px;top:50%;transform:translateY(-50%);
    width:60px;height:400px;background:rgba(10,10,10,0.9);
    backdrop-filter:blur(8px);border-radius:12px;
    border:1px solid rgba(255,255,255,0.08);
    padding:20px 12px;display:none;flex-direction:column;align-items:center;
    z-index:100;
  }
  #rewindUI.on{display:flex}
  #rewindSlider{
    width:4px;height:100%;background:rgba(255,255,255,0.1);
    border-radius:4px;position:relative;cursor:pointer;
  }
  #rewindHandle{
    position:absolute;left:50%;transform:translateX(-50%);
    width:16px;height:16px;background:var(--accent);border-radius:50%;
    cursor:grab;transition:transform .1s;
  }
  #rewindHandle:active{cursor:grabbing;transform:translateX(-50%) scale(1.2)}
  
  /* Final CTA */
  .cta-wrap{display:flex;gap:16px;align-items:center;justify-content:center;margin-top:18px}
  .btn{
    padding:12px 24px;border-radius:999px;border:1px solid rgba(255,255,255,0.1);
    background:transparent;color:var(--fg);cursor:pointer;font-family:var(--mono);
    font-size:16px;transition:all .18s var(--ease);
  }
  .btn:hover,.btn:focus{background:rgba(255,255,255,0.05);outline:2px solid var(--accent);outline-offset:2px}
  .btn.primary{background:var(--fg);color:var(--bg);border-color:transparent;font-weight:700}
  .btn.primary:hover{background:var(--accent);color:var(--bg)}
  
  /* Input modal */
  .modal{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    z-index:120;background:rgba(0,0,0,0.85);backdrop-filter:blur(12px);
    opacity:0;pointer-events:none;transition:opacity .18s ease}
  .modal.on{opacity:1;pointer-events:auto}
  .modal .box{
    background:#0b0b0b;border:1px solid rgba(255,255,255,0.08);
    padding:32px;border-radius:16px;max-width:560px;width:92%;
    box-shadow:0 8px 32px rgba(0,0,0,0.8);
  }
  input[type="text"], input[type="email"]{
    width:100%;padding:14px 16px;border-radius:8px;
    border:1px solid rgba(255,255,255,0.1);background:#050505;
    color:var(--fg);font-family:var(--mono);font-size:15px;
    transition:all .18s;
  }
  input:focus{outline:2px solid var(--accent);outline-offset:2px;border-color:var(--accent)}
  label{display:block;margin-bottom:8px;color:var(--muted);font-size:13px;font-family:var(--mono)}
  
  /* Proximity permission card */
  #proximityCard{
    position:fixed;bottom:28px;right:28px;padding:16px 20px;
    background:rgba(10,10,10,0.95);backdrop-filter:blur(12px);
    border-radius:12px;border:1px solid rgba(255,255,255,0.08);
    max-width:360px;z-index:80;
    opacity:0;transform:translateY(12px);
    transition:opacity .3s var(--ease),transform .3s var(--ease);
  }
  #proximityCard.on{opacity:1;transform:translateY(0)}
  .geo-btn{
    padding:8px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);
    background:transparent;color:var(--fg);font-family:var(--mono);
    font-size:13px;cursor:pointer;transition:all .18s;margin-right:8px;
  }
  .geo-btn.primary{background:var(--accent);color:var(--bg);border:none;font-weight:600}
  .geo-btn:hover{background:rgba(255,255,255,0.08)}
  .geo-btn.primary:hover{background:#00d66f}
  
  /* Reduced motion */
  @media (prefers-reduced-motion: reduce){
    .cursor{animation:none}
    #matrixCanvas,#residueCanvas,#shadowCursor{display:none}
    *{animation:none !important;transition-duration:0.01ms !important}
  }
  
  /* Mobile optimizations */
  @media (max-width:720px){
    .line{font-size:24px}
    .console{font-size:16px}
    .whisper{left:16px;bottom:16px;max-width:calc(100vw - 32px);font-size:12px}
    #proximityCard{right:16px;bottom:16px;max-width:calc(100vw - 32px)}
    .btn{padding:10px 18px;font-size:14px}
    #rewindUI{display:none !important} /* hide on mobile */
  }
  
  /* Safe area for notched devices */
  @supports(padding:max(0px)){
    .whisper{bottom:max(28px, env(safe-area-inset-bottom))}
    #proximityCard{bottom:max(28px, env(safe-area-inset-bottom))}
  }
  
  /* Pause presence toggle */
  #pauseToggle{
    position:fixed;top:20px;left:20px;z-index:200;
    padding:8px 12px;border-radius:8px;
    background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);
    color:var(--muted);font-size:11px;font-family:var(--mono);
    cursor:pointer;transition:all .18s;
  }
  #pauseToggle:hover{background:rgba(255,255,255,0.1);color:var(--fg)}
  #pauseToggle.paused{background:rgba(255,100,100,0.2);color:#ff6b6b;border-color:#ff6b6b}
</style>
</head>
<body>
  <!-- Accessibility: Skip intro -->
  <button id="skipIntro" class="skip-intro" aria-label="Skip introduction">skip intro</button>
  
  <!-- Pause presence toggle -->
  <button id="pauseToggle" aria-label="Pause presence features">presence: on</button>
  
  <!-- Canvas layers -->
  <canvas id="matrixCanvas" aria-hidden="true"></canvas>
  <canvas id="residueCanvas" aria-hidden="true"></canvas>
  
  <!-- Shadow cursor -->
  <div id="shadowCursor" aria-hidden="true" style="display:none"></div>
  
  <!-- Temporal rewind UI -->
  <div id="rewindUI" role="region" aria-label="Temporal rewind">
    <div style="font-size:10px;color:var(--muted);font-family:var(--mono);margin-bottom:12px;text-align:center">REWIND</div>
    <div id="rewindSlider">
      <div id="rewindHandle"></div>
    </div>
    <div style="font-size:10px;color:var(--muted);font-family:var(--mono);margin-top:12px">press ESC</div>
  </div>
  
  <!-- Initial console full-screen -->
  <main id="stage" class="full" aria-live="polite">
    <div id="consoleWrap" class="center-col" style="z-index:50">
      <div class="console" id="consoleText" aria-live="polite"></div>
      <div id="consoleCursor" class="cursor" style="margin-top:6px;display:none"></div>
    </div>
  </main>

  <!-- Breach overlay -->
  <div id="breach" class="breach hidden" aria-hidden="true"></div>

  <!-- Dossier screens container -->
  <div id="dossierContainer" style="display:none"></div>

  <!-- Whisper -->
  <div id="whisper" class="whisper" role="status" aria-live="polite"></div>

  <!-- Proximity permission card -->
  <div id="proximityCard" role="dialog" aria-labelledby="geoTitle">
    <div id="geoTitle" style="font-family:var(--mono);font-size:14px;margin-bottom:10px;color:var(--fg)">small request</div>
    <div class="muted" style="font-size:13px;margin-bottom:16px">let me sense your neighbourhood. used to make this feel… you.</div>
    <div>
      <button id="geoAllow" class="geo-btn primary">allow</button>
      <button id="geoSkip" class="geo-btn">skip</button>
    </div>
  </div>

  <!-- Contact modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="box">
      <div style="margin-bottom:16px">
        <div id="modalTitle" style="font-family:var(--mono);font-weight:700;font-size:20px;margin-bottom:8px">where can i find you?</div>
        <div class="muted" style="font-size:14px">email or phone. only used to reach you if you said yes.</div>
      </div>
      <form id="contactForm">
        <label for="contactInput">contact</label>
        <input id="contactInput" name="contact" type="text" placeholder="you@example.com or +1 415 555 0123" autocomplete="email tel" required />
        <div style="display:flex;gap:10px;margin-top:18px;justify-content:flex-end">
          <button type="button" id="modalCancel" class="btn">not yet</button>
          <button type="submit" class="btn primary">send</button>
        </div>
      </form>
    </div>
  </div>

<script>
// PRESENCE BREACH — Full implementation
// Features: Console breach, Shadow cursor, Memory residue, Temporal rewind, Behavior whispers, Geo proximity

'use strict';

/* ============= CONFIG & STATE ============= */
const CONFIG = {
  apiEndpoint: '/api/contact',
  skipIntroKey: 'hethar_skip_intro',
  lastVisitKey: 'hethar_last_visit',
  geoAskedKey: 'hethar_geo_asked',
  pausedKey: 'hethar_paused',
  sessionWhisperKey: 'hethar_session_whisper',
  residueKey: 'hethar_residue'
};

const STATE = {
  paused: localStorage.getItem(CONFIG.pausedKey) === '1',
  skipIntro: localStorage.getItem(CONFIG.skipIntroKey) === '1',
  geoAsked: localStorage.getItem(CONFIG.geoAskedKey) === '1',
  sessionWhisperShown: sessionStorage.getItem(CONFIG.sessionWhisperKey) === '1',
  currentDossier: 0,
  isLocked: false,
  recording: [], // temporal rewind recording
  rewindMode: false
};

/* ============= UTILITIES ============= */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
const rand = (arr)=> arr[Math.floor(Math.random()*arr.length)];
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ============= CITY INFERENCE ============= */
function inferCity() {
  const tz = (Intl && Intl.DateTimeFormat) ? Intl.DateTimeFormat().resolvedOptions().timeZone || '' : '';
  const map = [
    {match:/America\/Los_Angeles|PST|Pacific/, city:'SAN FRANCISCO NODE'},
    {match:/America\/New_York|EST|Eastern/, city:'NYC NODE'},
    {match:/Europe\/London|GMT/, city:'LONDON NODE'},
    {match:/Asia\/Tokyo/, city:'TOKYO NODE'},
    {match:/Europe\/Berlin/, city:'BERLIN NODE'},
    {match:/Europe\/Paris/, city:'PARIS NODE'},
    {match:/America\/Chicago|Central/, city:'CHICAGO NODE'}
  ];
  for (const m of map){
    if (m.match.test(tz)) return m.city;
  }
  if (tz && tz.includes('/')) return tz.split('/')[1].toUpperCase().replace('_',' ') + ' NODE';
  return 'NEARBY NODE';
}

/* ============= TYPING EFFECT ============= */
async function typeText(el, text, speed=40, opts={cursor:true}) {
  el.textContent = '';
  if (opts.cursor) showCursor(true);
  for (let i=0;i<text.length;i++){
    el.textContent += text[i];
    await sleep(speed + Math.random()*10);
  }
  if (opts.cursor) showCursor(false);
}

function showCursor(on){
  const c = document.getElementById('consoleCursor');
  if(!c) return;
  c.style.display = on ? 'inline-block' : 'none';
}

/* ============= MATRIX CANVAS ============= */
const matrixCanvas = document.getElementById('matrixCanvas');
const matrixCtx = matrixCanvas.getContext('2d');
let matrixRunning = false;

function fitCanvas(canvas){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
fitCanvas(matrixCanvas);
addEventListener('resize', ()=>fitCanvas(matrixCanvas));

function startMatrix() {
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
  if (STATE.paused) return;
  matrixRunning = true;
  const cols = Math.floor(matrixCanvas.width / 14);
  const drops = Array.from({length:cols}).map(()=>Math.random()*-100);
  (function draw(){
    if(!matrixRunning) return;
    matrixCtx.fillStyle = 'rgba(0,0,0,0.05)';
    matrixCtx.fillRect(0,0,matrixCanvas.width,matrixCanvas.height);
    matrixCtx.fillStyle = '#00ff7f';
    matrixCtx.font = '13px monospace';
    for (let i=0;i<drops.length;i++){
      const x = i * 14;
      const y = drops[i] * 14;
      const text = String.fromCharCode(33 + Math.random()*94);
      matrixCtx.fillText(text, x, y);
      if (y > matrixCanvas.height && Math.random() > 0.975) drops[i]=0;
      drops[i]++;
    }
    requestAnimationFrame(draw);
  })();
}

function stopMatrix(){ 
  matrixRunning=false; 
  matrixCtx.clearRect(0,0,matrixCanvas.width,matrixCanvas.height); 
}

/* ============= MEMORY RESIDUE CANVAS ============= */
const residueCanvas = document.getElementById('residueCanvas');
const residueCtx = residueCanvas.getContext('2d');
fitCanvas(residueCanvas);
addEventListener('resize', ()=>fitCanvas(residueCanvas));

const pathBuffer = [];
let lastPathTime = Date.now();

function recordPath(x, y){
  if (STATE.paused) return;
  pathBuffer.push({x, y, t:Date.now()});
  // Keep last 5 seconds
  const cutoff = Date.now() - 5000;
  while (pathBuffer.length && pathBuffer[0].t < cutoff) pathBuffer.shift();
}

function drawResidue(){
  if (STATE.paused) return;
  // Fade existing
  residueCtx.fillStyle = 'rgba(0,0,0,0.02)';
  residueCtx.fillRect(0,0,residueCanvas.width,residueCanvas.height);
  
  // Draw recent path
  if (pathBuffer.length < 2) return;
  residueCtx.strokeStyle = 'rgba(0,255,127,0.15)';
  residueCtx.lineWidth = 2;
  residueCtx.lineCap = 'round';
  residueCtx.globalCompositeOperation = 'lighter';
  
  residueCtx.beginPath();
  residueCtx.moveTo(pathBuffer[0].x, pathBuffer[0].y);
  for (let i=1; i<pathBuffer.length; i++){
    residueCtx.lineTo(pathBuffer[i].x, pathBuffer[i].y);
  }
  residueCtx.stroke();
  residueCtx.globalCompositeOperation = 'source-over';
  
  requestAnimationFrame(drawResidue);
}

window.addEventListener('pointermove', e=>{
  recordPath(e.clientX, e.clientY);
  recordEvent('move', {x:e.clientX, y:e.clientY});
}, {passive:true});

requestAnimationFrame(drawResidue);

/* ============= SHADOW CURSOR (Predictive) ============= */
const shadowCursor = document.getElementById('shadowCursor');
let mouse = {x:0, y:0, vx:0, vy:0, ts:Date.now()};

window.addEventListener('pointermove', e=>{
  const now = Date.now();
  const dt = Math.max(6, now - mouse.ts);
  mouse.vx = (e.clientX - mouse.x)/dt;
  mouse.vy = (e.clientY - mouse.y)/dt;
  mouse.x = e.clientX; 
  mouse.y = e.clientY; 
  mouse.ts = now;
}, {passive:true});

function perlinNoise(t){ 
  return (Math.sin(t*0.0023)+Math.sin(t*0.0071)*0.5)*0.5; 
}

function tickShadow(){
  if (STATE.paused || window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
    shadowCursor.style.display = 'none';
    requestAnimationFrame(tickShadow);
    return;
  }
  
  shadowCursor.style.display = 'block';
  
  // Project forward
  const lead = 140 + (30 * Math.random());
  const px = mouse.x + mouse.vx * lead;
  const py = mouse.y + mouse.vy * lead;
  
  // Human noise
  const jitter = perlinNoise(Date.now()) * 8;
  const tx = px + jitter;
  const ty = py + jitter;
  
  // Easing lag
  const current = shadowCursor.getBoundingClientRect();
  const cx = current.left + current.width/2;
  const cy = current.top + current.height/2;
  const nx = cx + (tx - cx) * 0.18;
  const ny = cy + (ty - cy) * 0.18;
  
  shadowCursor.style.left = nx + 'px';
  shadowCursor.style.top = ny + 'px';
  
  requestAnimationFrame(tickShadow);
}
tickShadow();

/* ============= TEMPORAL REWIND ============= */
function recordEvent(type, data){
  if (STATE.paused) return;
  STATE.recording.push({type, data, t:Date.now()});
  // Keep last 3 minutes
  const cutoff = Date.now() - 180000;
  while (STATE.recording.length && STATE.recording[0].t < cutoff) STATE.recording.shift();
}

window.addEventListener('keydown', e=>{
  recordEvent('key', {key:e.key});
  
  // R = toggle rewind mode
  if (e.key === 'r' || e.key === 'R'){
    if (!STATE.rewindMode && document.getElementById('dossierContainer').style.display === 'block'){
      STATE.rewindMode = true;
      document.getElementById('rewindUI').classList.add('on');
    }
  }
  
  // ESC = exit rewind
  if (e.key === 'Escape'){
    STATE.rewindMode = false;
    document.getElementById('rewindUI').classList.remove('on');
    closeModal();
  }
});

// Rewind slider interaction
let rewindDragging = false;
const rewindHandle = document.getElementById('rewindHandle');
const rewindSlider = document.getElementById('rewindSlider');

rewindHandle.addEventListener('mousedown', ()=> rewindDragging = true);
document.addEventListener('mouseup', ()=> rewindDragging = false);
document.addEventListener('mousemove', e=>{
  if (!rewindDragging) return;
  const rect = rewindSlider.getBoundingClientRect();
  const y = Math.max(0, Math.min(rect.height, e.clientY - rect.top));
  const pct = y / rect.height;
  rewindHandle.style.top = (pct * 100) + '%';
  
  // Scrub through recording
  const targetTime = Date.now() - (pct * 180000); // 3 min max
  // TODO: render past events at targetTime
  showWhisper(`rewind: ${Math.round(pct*180)}s ago`);
});

/* ============= AUDIO CLICK ============= */
function audioClick(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.value = 1200;
    g.gain.value = 0.001;
    o.connect(g); 
    g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 80);
  }catch(e){}
}

/* ============= CONSOLE / BREACH FLOW ============= */
const consoleText = document.getElementById('consoleText');
const breachEl = document.getElementById('breach');

async function launchSequence(){
  await sleep(300);
  await typeText(consoleText, 'ACCESSING PRESENCE…', 35, {cursor:true});
  await sleep(300);
  
  const city = inferCity();
  consoleText.textContent += `\n[${city}]`;
  await sleep(400);
  
  await typeText(consoleText, '\nAUTHENTICATING… YOU', 30, {cursor:true});
  await sleep(400);
  
  consoleText.textContent += '\n…CONFIRMED.';
  await sleep(500);
  
  // Ghost deletion with green flicker
  await ghostDelete();
  
  // Breach sequence
  await breachSequence();
}

async function ghostDelete(){
  const lines = consoleText.textContent.split('\n');
  const lastLine = lines[lines.length - 1];
  
  for (let i = lastLine.length; i > 0; i--){
    lines[lines.length - 1] = lastLine.slice(0, i);
    consoleText.textContent = lines.join('\n');
    breachEl.classList.remove('hidden');
    breachEl.style.opacity = '0.3';
    await sleep(16 + Math.random()*20);
  }
  
  startMatrix();
  await sleep(250);
}

async function breachSequence(){
  breachEl.classList.remove('hidden');
  breachEl.style.opacity = '1';
  audioClick();
  await sleep(400);
  
  breachEl.style.transition = 'opacity .6s var(--ease)';
  breachEl.style.opacity = '0';
  await sleep(600);
  
  stopMatrix();
  breachEl.classList.add('hidden');
  
  // Type final line
  consoleText.textContent = '';
  await typeText(consoleText, 'i was already here.', 24, {cursor:false});
  await sleep(1000);
  
  await showDossiers();
}

/* ============= DOSSIERS ============= */
const LINES = [
  'inputs are over.',
  'life is outcomes-only.',
  'you don't use it. it lives with you.',
  'your ai assistant is mid.',
  'copilots ≠ pilots — they autocomplete, they don't lead.',
  'memory ≠ intelligence — remembering isn't knowing.',
  'assistants ≠ partners — they take orders. we take outcomes.',
  'not a copilot. a co-you.',
  'the mind — lives across your devices. acts before you ask.',
  'the body — a discreet sense organ that feeds the mind.',
  'stop managing life. start living it.',
  'presence > prompts.',
  'we built a second presence.',
  'you don't use hethar. you live with it.'
];

const dossierContainer = document.getElementById('dossierContainer');

function makeDossiers(){
  dossierContainer.innerHTML = '';
  
  LINES.forEach((text, idx)=>{
    const node = document.createElement('section');
    node.className = 'dossier';
    node.setAttribute('data-idx', idx);
    node.innerHTML = `
      <div class="card">
        <div class="line">${escapeHtml(text)}</div>
      </div>
    `;
    dossierContainer.appendChild(node);
  });
  
  // Final CTA
  const final = document.createElement('section');
  final.className = 'dossier';
  final.innerHTML = `
    <div class="card" style="display:flex;flex-direction:column;align-items:center;gap:20px;text-align:center">
      <div class="line">DO YOU WANT TO LIVE WITH IT?</div>
      <div class="muted">not a demo. a decision.</div>
      <div class="cta-wrap">
        <button id="chooseY" class="btn primary" aria-label="Yes, I want to live with it">Y</button>
        <button id="chooseN" class="btn" aria-label="No, not yet">N</button>
      </div>
      <div class="muted" style="font-size:12px;margin-top:12px">keyboard: Y or N</div>
    </div>
  `;
  dossierContainer.appendChild(final);
}

async function showDossiers(){
  makeDossiers();
  dossierContainer.style.display = 'block';
  document.getElementById('stage').style.display = 'none';
  
  attachNavigation();
  scrollToIndex(0, false);
  
  // Wire final CTA
  document.getElementById('chooseY').addEventListener('click', openModal);
  document.getElementById('chooseN').addEventListener('click', tweetReaction);
  
  // Show proximity card if not asked yet
  if (!STATE.geoAsked && !STATE.paused){
    setTimeout(showProximityCard, 3000);
  }
  
  // Analytics
  trackEvent('dossier_start');
}

/* ============= NAVIGATION ============= */
function attachNavigation(){
  window.addEventListener('wheel', onWheel, {passive:false});
  window.addEventListener('keydown', onKey);
  
  // Touch
  let startY = null;
  window.addEventListener('touchstart', e=> startY = e.touches[0].clientY, {passive:true});
  window.addEventListener('touchend', e=>{
    if(startY!==null){
      const dy = e.changedTouches[0].clientY - startY;
      if(dy < -40) next();
      if(dy > 40) prev();
    }
    startY=null;
  }, {passive:true});
}

let wheelTimer = null;
function onWheel(e){
  e.preventDefault();
  if (wheelTimer) return;
  wheelTimer = setTimeout(()=> wheelTimer = null, 400);
  if (e.deltaY > 10) next();
  else if (e.deltaY < -10) prev();
}

function onKey(e){
  if (STATE.rewindMode) return;
  if (e.key === 'ArrowDown' || e.key==='PageDown') next();
  if (e.key === 'ArrowUp' || e.key==='PageUp') prev();
  if (e.key === 'y' || e.key === 'Y') openModal();
  if (e.key === 'n' || e.key === 'N') tweetReaction();
}

function next(){ 
  if (STATE.isLocked) return; 
  scrollToIndex(STATE.currentDossier + 1); 
}

function prev(){ 
  if (STATE.isLocked) return; 
  scrollToIndex(STATE.currentDossier - 1); 
}

function scrollToIndex(idx, smooth=true){
  const children = Array.from(dossierContainer.children);
  if (idx < 0) idx = 0;
  if (idx >= children.length) idx = children.length - 1;
  STATE.currentDossier = idx;
  
  const el = children[idx];
  if (!el) return;
  
  STATE.isLocked = true;
  el.scrollIntoView({behavior: smooth ? 'smooth' : 'auto', block:'center'});
  setTimeout(()=> STATE.isLocked = false, 600);
  
  trackEvent('dossier_view', {index: idx});
}

/* ============= WHISPERS ============= */
const whisperEl = document.getElementById('whisper');
let idleTimer;

function resetIdle(){
  clearTimeout(idleTimer);
  if (STATE.paused) return;
  idleTimer = setTimeout(()=>{
    if (STATE.sessionWhisperShown) return;
    showWhisper(rand([
      'you paused. i noticed.',
      'don't overthink. say it.',
      'i remember when you tried this last time.',
      'still here? good.',
      'you're hesitating. i'll wait.'
    ]));
    STATE.sessionWhisperShown = true;
    sessionStorage.setItem(CONFIG.sessionWhisperKey, '1');
  }, 4000);
}

['mousemove','keydown','scroll','touchstart'].forEach(ev=>
  window.addEventListener(ev, resetIdle, {passive:true})
);
resetIdle();

function showWhisper(msg){
  whisperEl.textContent = msg;
  whisperEl.classList.add('on');
  setTimeout(()=> whisperEl.classList.remove('on'), 2000);
  trackEvent('whisper_show', {message: msg});
}

/* Exit intent */
let exitFired = false;
window.addEventListener('mouseout', e=>{
  if (exitFired || STATE.paused) return;
  if (!e.relatedTarget && e.clientY <= 0){
    exitFired = true;
    showFloatingFlash(rand([
      "leaving already? i wasn't done watching you.",
      "you'll be back. i'll remember.",
      "don't go. i'm only getting started."
    ]));
    setTimeout(()=> exitFired = false, 5000);
  }
});

function showFloatingFlash(msg){
  const el = document.createElement('div');
  el.className = 'whisper on';
  el.style.left = '50%';
  el.style.transform = 'translateX(-50%)';
  el.style.bottom = '15%';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(()=> el.classList.remove('on'), 2000);
  setTimeout(()=> el.remove(), 2500);
  trackEvent('exit_intent');
}

/* ============= PROXIMITY GEO ============= */
function showProximityCard(){
  const card = document.getElementById('proximityCard');
  card.classList.add('on');
  trackEvent('geo_prompt_show');
}

document.getElementById('geoAllow').addEventListener('click', async ()=>{
  document.getElementById('proximityCard').classList.remove('on');
  STATE.geoAsked = true;
  localStorage.setItem(CONFIG.geoAskedKey, '1');
  trackEvent('geo_allow');
  
  try {
    const pos = await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, {timeout:8000});
    });
    const {latitude, longitude} = pos.coords;
    
    // Compute distance to SF (example)
    const dist = haversineDistance(latitude, longitude, 37.7749, -122.4194);
    
    if (dist < 120) {
      setTimeout(()=>{
        showWhisper(rand([
          'close enough to hear the VC pitches. don't pretend you can't.',
          'not in SF proper — but within the current. i feel the echo.',
          'you orbit the hub. the hub leaks into you.'
        ]));
      }, 2000);
    }
    
    trackEvent('geo_success', {lat: latitude.toFixed(2), lng: longitude.toFixed(2), distance: dist});
  } catch(e) {
    // Fallback to timezone
    trackEvent('geo_denied');
  }
});

document.getElementById('geoSkip').addEventListener('click', ()=>{
  document.getElementById('proximityCard').classList.remove('on');
  STATE.geoAsked = true;
  localStorage.setItem(CONFIG.geoAskedKey, '1');
  trackEvent('geo_skip');
});

function haversineDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* ============= MODAL ============= */
const modal = document.getElementById('modal');
const contactForm = document.getElementById('contactForm');

function openModal(){
  modal.classList.add('on');
  modal.setAttribute('aria-hidden', 'false');
  document.getElementById('contactInput').focus();
  trackEvent('modal_open');
}

function closeModal(){
  modal.classList.remove('on');
  modal.setAttribute('aria-hidden', 'true');
}

document.getElementById('modalCancel').addEventListener('click', ()=>{
  closeModal();
  trackEvent('modal_cancel');
});

contactForm.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const val = document.getElementById('contactInput').value.trim();
  
  if (!val) {
    showWhisper('give a contact. or come back later.');
    return;
  }
  
  // Submit to backend
  try {
    const response = await fetch(CONFIG.apiEndpoint, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        contact: val,
        timestamp: new Date().toISOString(),
        source: 'breach_site'
      })
    });
    
    if (response.ok) {
      closeModal();
      showFloatingFlash('received. i'll find you.');
      trackEvent('contact_submit_success', {contact: val});
    } else {
      showWhisper('something failed. try again or email team@hethar.app');
      trackEvent('contact_submit_error');
    }
  } catch(e) {
    console.log('Contact submitted (demo):', val);
    closeModal();
    showFloatingFlash('received. i'll find you.');
    trackEvent('contact_submit_demo', {contact: val});
  }
});

function tweetReaction(){
  const u = encodeURIComponent('https://hethar.app');
  const text = encodeURIComponent("i just saw hethar. 'do you want to live with it?' wild.");
  window.open(`https://twitter.com/intent/tweet?text=${text}&url=${u}`, '_blank');
  trackEvent('tweet_click');
}

/* ============= CONTROLS ============= */
// Skip intro
document.getElementById('skipIntro').addEventListener('click', ()=>{
  localStorage.setItem(CONFIG.skipIntroKey, '1');
  STATE.skipIntro = true;
  if (document.getElementById('dossierContainer').style.display === 'none'){
    showDossiers();
  }
  trackEvent('skip_intro');
});

// Pause toggle
document.getElementById('pauseToggle').addEventListener('click', ()=>{
  STATE.paused = !STATE.paused;
  localStorage.setItem(CONFIG.pausedKey, STATE.paused ? '1' : '0');
  const btn = document.getElementById('pauseToggle');
  btn.textContent = STATE.paused ? 'presence: paused' : 'presence: on';
  btn.classList.toggle('paused', STATE.paused);
  
  if (STATE.paused) {
    stopMatrix();
  } else {
    startMatrix();
  }
  
  trackEvent('presence_toggle', {paused: STATE.paused});
});

/* ============= ANALYTICS ============= */
function trackEvent(name, props = {}) {
  // Plausible.io event tracking (privacy-friendly)
  if (window.plausible) {
    window.plausible(name, {props});
  }
  
  // Or custom analytics endpoint
  // fetch('/api/analytics', { method: 'POST', body: JSON.stringify({event: name, ...props}) });
  
  console.log('[Analytics]', name, props);
}

/* ============= BOOT ============= */
(async function init(){
  // Record last visit
  const lastVisit = localStorage.getItem(CONFIG.lastVisitKey);
  if (lastVisit) {
    const elapsed = Date.now() - parseInt(lastVisit);
    console.log('Last visit:', Math.round(elapsed/1000/60), 'minutes ago');
  }
  localStorage.setItem(CONFIG.lastVisitKey, Date.now());
  
  trackEvent('page_load');
  
  // Check if skip intro
  if (STATE.skipIntro) {
    await showDossiers();
    return;
  }
  
  // Launch breach sequence
  await launchSequence();
})();

// Service worker for offline (optional)
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(e => console.log('SW registration failed'));
}
</script>

<!-- Analytics (Plausible.io - privacy-friendly) -->
<script defer data-domain="hethar.app" src="https://plausible.io/js/script.js"></script>

</body>
</html>
